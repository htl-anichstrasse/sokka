\section{Cookie-Storage}

Damit sich ein User des Clients nicht nach jedem App-Neustart erneut mit seinen Logindaten anmelden muss,
werden dessen Email sowie der generierte Session-Token, der nach einem erfolgreichem Login erhalten wird, 
in Form von Cookies im externen Speichers des Geräts abgespeichert.

% https://flutter.dev/docs/cookbook/persistence/key-value

Damit dies plattformunabhängig funktioniert, wird das \lstinline{shared-preferences}-Package von Flutter
verwendet.
Dieses Plugin wrapped die \lstinline{NSUserDefaults} von iOS und die \lstinline{SharedPreferences} von Android
wodurch Key-Value-Paare persistent unabhängig des Betriebssystems abgespeichert werden können.

Damit die Daten, die im CookieStorage gespeichert sind, global in der App verfügbar sind, wird in jener
Klasse das \textit{Singleton-Design-Pattern} angewendet. Dieses ermöglicht, dass immer dieselbe, einzige Instanz
dieser Klasse aufgerufen wird, anstatt immer neue Objekte per Konstruktor anzulegen.

Dart hat hierfür eine eigene syntaktische Lösung:

\begin{lstlisting}
class CookieStorage {
    // Eigentliche Instanz des CookieStorages
    static CookieStorage _instance = new CookieStorage.internal();

    // Singleton-Konstruktor, der immer _instance retourniert anstatt ein neues Objekt
    // zu erzeugen
    factory CookieStorage() => _instance;

    ...

    // Eigentlicher Konstruktor
    CookieStorage.internal();
}
\end{lstlisting}

Innerhalb der Klasse besitzt der CookieStorage zusätzlich eine Map \lstinline{Map<String, String>}, in der die Key-Value-Paare
gespeichert nochmals abgespeichert werden, damit sie in notwendigen Situationen synchron abgefragt werden können.

Das Speichern und Abfragen von Werten, die im externen Speicher des Geräts gespeichert sind erfolgt über
eine Instanz der \textit{SharedPreferences}:

\begin{lstlisting}
import 'package:shared_preferences/shared_preferences.dart';

...

// Retourniert den String, der mit entsprechendem Key gespeichert wurde
Future<String> getString(final String key) async {
    return await SharedPreferences.getInstance().getString(key);
}

// Speichert den Argument-String mit entsprechendem Key ab
Future<void> storeString(final String key, final String value) async {
    await SharedPreferences.getInstance().setString(key, value);
}
\end{lstlisting}

Damit die gespeicherten Daten auch in der App persistent abgerufen werden können, gibt es klassenintern
im CookieStorage vorgefertigte, statische Keys sowohl für den Session-Token als auch für die User-Email-Adresse:

\begin{lstlisting}
static const TOKEN_KEY = 'token';
static const EMAIL_KEY = 'email';
\end{lstlisting}
\pagebreak
So können Fehler, die durch Tippfehler oder falsche Angaben des Keys beim Abspeichern bzw. Abfragen
von Werten entstehen, zur Gänze verhindert werden.\\
Anstatt den Key also manuell anzugeben kann dieser nun simpel über die statische Klassenvariable
aufgerufen werden.

\begin{lstlisting}
Future<String> getEmail() async {
    return await SharedPreferences.getInstance()
        .getString(CookieStorage.EMAIL_KEY);
}

Future<void> storeEmail(final String email) async {
    await SharedPreferences.getInstance()
        .setString(CookieStorage.EMAIL_KEY, email);
}
\end{lstlisting}






